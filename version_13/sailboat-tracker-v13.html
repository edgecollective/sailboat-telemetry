
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Tracker v13</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #121212; color: white; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 350px; background: #1e1e1e; padding: 15px; box-sizing: border-box; border-right: 1px solid #333; overflow-y: auto; z-index: 1000; display: flex; flex-direction: column; }
        #map { flex-grow: 1; height: 100vh; background-color: #121212; cursor: crosshair; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 12px; color: #aaa; font-weight: 500; }
        input, button { width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; font-size: 14px; box-sizing: border-box; }
        button { background: #007aff; cursor: pointer; margin-top: 10px; font-weight: 600; transition: background-color 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #555; cursor: not-allowed; }
        #status { font-size: 12px; color: #888; margin-top: auto; padding-top: 15px; border-top: 1px solid #333; line-height: 1.4; }
        #boat-list-container { flex-grow: 1; margin-top: 20px; display: flex; flex-direction: column; }
        .boat-info-card { background: #2a2a2a; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid; transition: all 0.3s; cursor: pointer; display: flex; gap: 15px; align-items: center; order: 0; }
        .boat-info-card.selected { background-color: #3c3c3c; border-left-width: 8px; }
        .boat-details { flex-grow: 1; }
        .boat-info-card h4 { margin: 0 0 10px 0; font-size: 16px; }
        .boat-data-grid { display: grid; grid-template-columns: 1fr; gap: 4px; font-size: 12px; color: #ccc; }
        .boat-data-grid span { font-weight: 600; color: white; }
        .distance-label { font-weight: bold; color: #48dbfb; }
        .tilt-display { width: 80px; height: 80px; position: relative; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid #444; border-radius: 50%; background: #222; }
        .tilt-tick { position: absolute; width: 1px; height: 5px; background: #777; transform-origin: center 40px; left: 50%; top: 0;}
        .tilt-tick.major { height: 8px; background: #aaa; }
        .tilt-graphic { width: 100%; height: 100%; transition: transform 0.3s ease; position: absolute; }
        .boat-hull { width: 50px; height: 25px; background-color: #8B4513; border-radius: 0 0 25px 25px; position: absolute; bottom: 15px; left: 15px; }
        .boat-mast { width: 4px; height: 25px; background-color: #ccc; position: absolute; bottom: 40px; left: 38px; transform-origin: bottom center; }
        .boat-icon-wrapper, .shore-icon-wrapper { text-align: center; line-height: 30px; }
        .boat-label, .distance-line-label { background: rgba(0,0,0,0.7); color: white; padding: 3px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: none; text-align: center; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Fleet Tracker v13</h2>
        <div class="control-group">
            <label for="fileUrl">CSV File URL:</label>
            <input type="text" id="fileUrl" value="./sailboat_data_multi.csv" />
        </div>
        <div class="control-group">
            <label for="updateInterval">Update Interval (s):</label>
            <input type="number" id="updateInterval" value="2" min="1" max="60" />
        </div>
        <button id="startTracking">Start Tracking</button>
        <button id="stopTracking" disabled>Stop Tracking</button>
        
        <div id="boat-list-container"></div>
        <div id="status">Click on the map to set a shore point.</div>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script>
        class FleetTrackerV13 {
            constructor() {
                this.map = null;
                this.sailboats = new Map();
                this.shorePoint = null;
                this.selectedBoatId = null;
                this.isTracking = false;
                this.updateInterval = null;
                this.lastData = "";
                this.fileUrl = document.getElementById('fileUrl').value;
                this.boatListContainer = document.getElementById('boat-list-container');
                this.boatColors = ['#ff6b6b', '#48dbfb', '#1dd1a1', '#feca57', '#ff9ff3', '#54a0ff'];
                this.TRAIL_LENGTH = 10;

                this.initMap();
                this.initControls();
            }

            initMap() {
                this.map = L.map('map').setView([41.777, -71.389], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'CARTO' }).addTo(this.map);
                this.map.on('click', (e) => this.setShorePoint(e.latlng));
            }

            initControls() {
                document.getElementById('startTracking').addEventListener('click', () => this.startTracking());
                document.getElementById('stopTracking').addEventListener('click', () => this.stopTracking());
                document.getElementById('fileUrl').addEventListener('change', (e) => this.fileUrl = e.target.value);
            }

            setShorePoint(latlng) {
                if (this.shorePoint) this.map.removeLayer(this.shorePoint);
                const shoreIcon = L.divIcon({ html: '<svg width="24" height="24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#feca57"/></svg>', className: 'shore-icon-wrapper', iconSize: [24, 24], iconAnchor: [12, 24] });
                this.shorePoint = L.marker(latlng, { icon: shoreIcon, draggable: true }).addTo(this.map);
                this.shorePoint.on('dragend', () => this.updateAllDistances());
                this.updateStatus('Shore point set. Drag to move.');
                this.updateAllDistances();
            }

            updateAllDistances() {
                if (!this.shorePoint) return;
                this.sailboats.forEach(boat => {
                    boat.distance = this.shorePoint.getLatLng().distanceTo([boat.lat, boat.lng]);
                });
                this.updateUI();
            }

            startTracking() {
                if (this.isTracking) return;
                this.isTracking = true;
                document.getElementById('startTracking').disabled = true;
                document.getElementById('stopTracking').disabled = false;
                this.updateStatus('Starting tracking...');
                this.fetchAndProcessFile();
                const interval = parseInt(document.getElementById('updateInterval').value, 10) * 1000;
                this.updateInterval = setInterval(() => this.fetchAndProcessFile(), interval);
            }

            stopTracking() {
                if (!this.isTracking) return;
                this.isTracking = false;
                document.getElementById('startTracking').disabled = false;
                document.getElementById('stopTracking').disabled = true;
                clearInterval(this.updateInterval);
                this.updateStatus('Tracking stopped.');
            }

            async fetchAndProcessFile() {
                try {
                    const response = await fetch(this.fileUrl + `?t=${Date.now()}`, { cache: 'no-cache' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const csvContent = await response.text();
                    if (csvContent === this.lastData) return;
                    this.lastData = csvContent;
                    Papa.parse(csvContent, { header: true, skipEmptyLines: true, complete: (results) => this.processCSVData(results.data) });
                } catch (error) {
                    this.updateStatus(`Error: ${error.message}`);
                    console.error('Fetch error:', error);
                }
            }

            processCSVData(data) {
                const allBoatData = new Map();
                for (const row of data) {
                    if (!row.sailboat_id) continue;
                    if (!allBoatData.has(row.sailboat_id)) allBoatData.set(row.sailboat_id, []);
                    allBoatData.get(row.sailboat_id).push({ lat: parseFloat(row.latitude), lng: parseFloat(row.longitude), heading: parseFloat(row.compass_heading), tilt: parseFloat(row.tilt) });
                }

                allBoatData.forEach((history, id) => {
                    const latestData = history[history.length - 1];
                    const trail = history.slice(-this.TRAIL_LENGTH);
                    const distance = this.shorePoint ? this.shorePoint.getLatLng().distanceTo([latestData.lat, latestData.lng]) : 0;

                    if (!this.sailboats.has(id)) {
                        const color = this.boatColors[this.sailboats.size % this.boatColors.length];
                        this.sailboats.set(id, { id, ...latestData, color, trail, distance, marker: null, trailLayer: null, cardElement: null, distanceLine: null });
                    } else {
                        const boat = this.sailboats.get(id);
                        Object.assign(boat, latestData, { trail, distance });
                    }
                });
                this.updateUI();
            }

            updateUI() {
                const sortedBoats = Array.from(this.sailboats.values()).sort((a, b) => b.distance - a.distance);
                
                sortedBoats.forEach((boat, index) => {
                    if (!boat.cardElement) this.createBoatCard(boat.id);
                    boat.cardElement.style.order = index;
                    this.updateBoatOnMap(boat.id);
                    this.updateBoatCard(boat.id);
                });

                this.updateStatus(`Tracking ${this.sailboats.size} boats. Last update: ${new Date().toLocaleTimeString()}`);
            }

            createBoatCard(boatId) {
                const boat = this.sailboats.get(boatId);
                const card = document.createElement('div');
                card.className = 'boat-info-card';
                card.id = `card-${boatId}`;
                card.style.borderColor = boat.color;
                
                let ticksHtml = '';
                for(let i = 0; i < 360; i += 15) {
                    const isMajor = i % 90 === 0;
                    ticksHtml += `<div class="tilt-tick ${isMajor ? 'major' : ''}" style="transform: rotate(${i}deg);"></div>`;
                }

                card.innerHTML = `
                    <div class="tilt-display">
                        ${ticksHtml}
                        <div class="tilt-graphic">
                            <div class="boat-hull"></div>
                            <div class="boat-mast"></div>
                        </div>
                    </div>
                    <div class="boat-details">
                        <h4>${boatId}</h4>
                        <div class="boat-data-grid">
                            <div>Lat: <span class="data-lat">--</span></div>
                            <div>Lng: <span class="data-lng">--</span></div>
                            <div>Heading: <span class="data-heading">--</span></div>
                            <div>Tilt: <span class="data-tilt">--</span></div>
                            <div>Distance: <span class="distance-label">--</span></div>
                        </div>
                    </div>
                `;
                this.boatListContainer.appendChild(card);
                boat.cardElement = card;
                card.addEventListener('click', () => this.selectBoat(boatId));
            }

            selectBoat(boatId) {
                this.selectedBoatId = boatId;
                this.sailboats.forEach(b => {
                    b.cardElement.classList.toggle('selected', b.id === boatId);
                    if (b.marker) {
                        const tooltip = b.marker.getTooltip();
                        if (tooltip) {
                            const content = b.id === boatId && this.shorePoint ? `${b.id}<br>${(b.distance / 1000).toFixed(2)} km` : b.id;
                            tooltip.setContent(content);
                        }
                    }
                });
                this.map.flyTo([this.sailboats.get(boatId).lat, this.sailboats.get(boatId).lng], 16);
            }

            updateBoatCard(boatId) {
                const boat = this.sailboats.get(boatId);
                if (!boat || !boat.cardElement) return;
                const card = boat.cardElement;
                card.querySelector('.data-lat').textContent = boat.lat.toFixed(4);
                card.querySelector('.data-lng').textContent = boat.lng.toFixed(4);
                card.querySelector('.data-heading').textContent = `${boat.heading.toFixed(1)}°`;
                card.querySelector('.data-tilt').textContent = `${boat.tilt.toFixed(1)}°`;
                card.querySelector('.tilt-graphic').style.transform = `rotate(${boat.tilt}deg)`;
                card.querySelector('.distance-label').textContent = this.shorePoint ? `${(boat.distance / 1000).toFixed(2)} km` : 'N/A';
            }

            updateBoatOnMap(boatId) {
                const boat = this.sailboats.get(boatId);
                if (!boat) return;

                const iconSvg = `<svg width="24" height="24" viewBox="0 0 24 24"><path d="M12 2L2 22h20L12 2z" fill="${boat.color}" stroke="#ffffff" stroke-width="1.5" transform="rotate(${boat.heading}, 12, 12)"/></svg>`;
                const boatIcon = L.divIcon({ html: iconSvg, className: 'boat-icon-wrapper', iconSize: [24, 24], iconAnchor: [12, 12] });

                const isSelected = boat.id === this.selectedBoatId;
                const labelContent = isSelected && this.shorePoint ? `${boat.id}<br>${(boat.distance / 1000).toFixed(2)} km` : boat.id;

                if (boat.marker) {
                    boat.marker.setLatLng([boat.lat, boat.lng]).setIcon(boatIcon);
                    boat.marker.getTooltip().setContent(labelContent);
                } else {
                    boat.marker = L.marker([boat.lat, boat.lng], { icon: boatIcon }).addTo(this.map);
                    boat.marker.bindTooltip(labelContent, { permanent: true, direction: 'bottom', className: 'boat-label', offset: [0, 12] });
                    boat.trailLayer = L.polyline([], { color: boat.color, weight: 3, opacity: 0.6 }).addTo(this.map);
                }
                boat.trailLayer.setLatLngs(boat.trail.map(p => [p.lat, p.lng]));

                if (this.shorePoint) {
                    const linePoints = [this.shorePoint.getLatLng(), [boat.lat, boat.lng]];
                    if (boat.distanceLine) {
                        boat.distanceLine.setLatLngs(linePoints);
                    } else {
                        boat.distanceLine = L.polyline(linePoints, { color: '#feca57', weight: 2, opacity: 0.7, dashArray: '5, 10' }).addTo(this.map);
                    }
                }
            }

            updateStatus(message) {
                document.getElementById('status').textContent = message;
            }
        }

        document.addEventListener('DOMContentLoaded', () => new FleetTrackerV13());
    </script>
</body>
</html>
